<!DOCTYPE html>
<html layout:decorate="~{layout/layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
      xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title th:text="${title} + ' - ' + ${categoryName}">게시글 작성 - 자유게시판</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="container mt-4">
            <!-- 브레드크럼 -->
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/}">홈</a></li>
                    <li class="breadcrumb-item"><a th:href="@{'/board/' + ${categoryPath} + '/list'}" th:text="${categoryName}">자유게시판</a></li>
                    <li class="breadcrumb-item active" aria-current="page">글쓰기</li>
                </ol>
            </nav>

            <!-- 작성 폼 -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-pen me-2 text-primary"></i>
                        새 게시글 작성
                    </h4>
                    <span class="badge bg-secondary" th:text="${categoryName}">자유게시판</span>
                </div>
                
                <div class="card-body">
                    <form th:action="@{'/board/' + ${categoryPath} + '/write'}" th:object="${postCreateDto}" method="post">
                        
                        <!-- CSRF 토큰 -->
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        
                        <!-- 작성자 정보 표시 -->
                        <div class="mb-3 p-3 bg-light rounded">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user-circle fa-2x text-primary me-2"></i>
                                <div>
                                    <div class="fw-bold" sec:authentication="name">작성자</div>
                                    <small class="text-muted">로그인된 계정으로 게시글이 작성됩니다</small>
                                </div>
                            </div>
                        </div>

                        <!-- 제목 입력 -->
                        <div class="mb-4">
                            <label for="title" class="form-label">제목 <span class="text-danger">*</span></label>
                            <input type="text" 
                                   class="form-control" 
                                   id="title" 
                                   name="title"
                                   th:field="*{title}"
                                   th:classappend="${#fields.hasErrors('title')} ? 'is-invalid' : ''"
                                   placeholder="제목을 입력하세요 (2~200자)"
                                   maxlength="200"
                                   required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></div>
                            <div class="form-text">
                                <span id="titleCount">0</span>/200자
                            </div>
                        </div>

                        <!-- 내용 입력 -->
                        <div class="mb-4">
                            <label for="content" class="form-label">내용 <span class="text-danger">*</span></label>
                            <textarea class="form-control" 
                                      id="content" 
                                      name="content"
                                      th:field="*{content}"
                                      rows="15"
                                      th:classappend="${#fields.hasErrors('content')} ? 'is-invalid' : ''"
                                      placeholder="내용을 입력하세요 (10~10000자)"
                                      maxlength="10000"
                                      required></textarea>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('content')}" th:errors="*{content}"></div>
                            <div class="form-text d-flex justify-content-between">
                                <span>
                                    <span id="contentCount">0</span>/10,000자
                                </span>
                                <span class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    HTML 태그 사용 가능
                                </span>
                            </div>
                        </div>

                        <!-- 첨부파일 영역 (추후 구현) -->
                        <div class="mb-4">
                            <label class="form-label">첨부파일</label>
                            <div class="border rounded p-3 bg-light">
                                <div class="text-center text-muted py-2">
                                    <i class="fas fa-paperclip fa-2x mb-2 d-block"></i>
                                    <p class="mb-0">첨부파일 기능은 곧 추가될 예정입니다.</p>
                                </div>
                            </div>
                        </div>

                        <!-- 전역 에러 메시지 -->
                        <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger mb-4">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <div th:each="error : ${#fields.globalErrors()}" th:text="${error}"></div>
                        </div>

                        <!-- 작성 안내 -->
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-lightbulb me-2"></i>
                            <strong>작성 가이드</strong>
                            <ul class="mb-0 mt-2">
                                <li>게시글은 커뮤니티 규칙을 준수해야 합니다.</li>
                                <li>욕설, 비방, 개인정보 유출은 금지됩니다.</li>
                                <li>작성된 게시글은 관리자에 의해 삭제될 수 있습니다.</li>
                            </ul>
                        </div>

                        <!-- 버튼 그룹 -->
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <a th:href="@{'/board/' + ${categoryPath} + '/list'}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left me-1"></i>
                                    취소
                                </a>
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-primary me-2" onclick="previewPost()">
                                    <i class="fas fa-eye me-1"></i>
                                    미리보기
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane me-1"></i>
                                    등록하기
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 미리보기 모달 -->
            <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-eye me-2"></i>
                                미리보기
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="border-bottom pb-3 mb-3">
                                <h4 id="previewTitle">제목이 여기에 표시됩니다</h4>
                                <div class="text-muted small">
                                    <span sec:authentication="name">작성자</span>
                                    <span class="ms-3">방금 전</span>
                                </div>
                            </div>
                            <div id="previewContent" style="min-height: 200px; line-height: 1.8;">
                                내용이 여기에 표시됩니다.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                닫기
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="script">
        <script>
            // 글자 수 카운터
            function updateCharCount() {
                const titleInput = document.getElementById('title');
                const contentTextarea = document.getElementById('content');
                const titleCount = document.getElementById('titleCount');
                const contentCount = document.getElementById('contentCount');
                
                titleCount.textContent = titleInput.value.length;
                contentCount.textContent = contentTextarea.value.length;
                
                // 글자 수에 따른 색상 변경
                if (titleInput.value.length > 180) {
                    titleCount.className = 'text-warning';
                } else if (titleInput.value.length > 190) {
                    titleCount.className = 'text-danger';
                } else {
                    titleCount.className = '';
                }
                
                if (contentTextarea.value.length > 9000) {
                    contentCount.className = 'text-warning';
                } else if (contentTextarea.value.length > 9500) {
                    contentCount.className = 'text-danger';
                } else {
                    contentCount.className = '';
                }
            }

            // 미리보기 기능
            function previewPost() {
                const title = document.getElementById('title').value.trim();
                const content = document.getElementById('content').value.trim();
                
                if (!title || !content) {
                    alert('제목과 내용을 입력해주세요.');
                    return;
                }
                
                document.getElementById('previewTitle').textContent = title;
                document.getElementById('previewContent').innerHTML = content.replace(/\n/g, '<br>');
                
                const modal = new bootstrap.Modal(document.getElementById('previewModal'));
                modal.show();
            }

            // 페이지 로드 시 실행
            document.addEventListener('DOMContentLoaded', function() {
                const titleInput = document.getElementById('title');
                const contentTextarea = document.getElementById('content');
                
                // 초기 글자 수 계산
                updateCharCount();
                
                // 입력 시 글자 수 업데이트
                titleInput.addEventListener('input', updateCharCount);
                contentTextarea.addEventListener('input', updateCharCount);
                
                // 페이지 나가기 전 확인
                let formChanged = false;
                
                titleInput.addEventListener('input', function() {
                    formChanged = this.value.length > 0 || contentTextarea.value.length > 0;
                });
                
                contentTextarea.addEventListener('input', function() {
                    formChanged = titleInput.value.length > 0 || this.value.length > 0;
                });
                
                window.addEventListener('beforeunload', function(e) {
                    if (formChanged) {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                });
                
                // 폼 제출 시에는 beforeunload 무시
                document.querySelector('form').addEventListener('submit', function() {
                    formChanged = false;
                });
            });

            // 자동 저장 (localStorage 사용)
            function autoSave() {
                const title = document.getElementById('title').value;
                const content = document.getElementById('content').value;
                const categoryPath = '[[${categoryPath}]]';
                
                if (title || content) {
                    localStorage.setItem(`newPost_${categoryPath}_title`, title);
                    localStorage.setItem(`newPost_${categoryPath}_content`, content);
                    localStorage.setItem(`newPost_${categoryPath}_timestamp`, new Date().getTime());
                }
            }

            // 자동 저장된 내용 복원
            function restoreAutoSave() {
                const categoryPath = '[[${categoryPath}]]';
                const savedTitle = localStorage.getItem(`newPost_${categoryPath}_title`);
                const savedContent = localStorage.getItem(`newPost_${categoryPath}_content`);
                const savedTime = localStorage.getItem(`newPost_${categoryPath}_timestamp`);
                
                if (savedTitle && savedContent && savedTime) {
                    const saveTime = new Date(parseInt(savedTime));
                    const now = new Date();
                    const diffMinutes = (now - saveTime) / (1000 * 60);
                    
                    // 30분 이내에 저장된 내용만 복원
                    if (diffMinutes < 30) {
                        if (confirm(`${Math.round(diffMinutes)}분 전에 자동 저장된 내용이 있습니다. 복원하시겠습니까?`)) {
                            document.getElementById('title').value = savedTitle;
                            document.getElementById('content').value = savedContent;
                            updateCharCount();
                        }
                    }
                }
            }

            // 30초마다 자동 저장
            setInterval(autoSave, 30000);
            
            // 페이지 로드 시 자동 저장된 내용 확인
            document.addEventListener('DOMContentLoaded', restoreAutoSave);
            
            // 폼 제출 시 자동 저장 데이터 삭제
            document.querySelector('form').addEventListener('submit', function() {
                const categoryPath = '[[${categoryPath}]]';
                localStorage.removeItem(`newPost_${categoryPath}_title`);
                localStorage.removeItem(`newPost_${categoryPath}_content`);
                localStorage.removeItem(`newPost_${categoryPath}_timestamp`);
            });
        </script>
    </th:block>
</body>
</html>