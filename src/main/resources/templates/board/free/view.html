<!DOCTYPE html>
<html layout:decorate="~{layout/layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
      xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title th:text="${title} + ' - ' + ${categoryName}">게시글 제목 - 자유게시판</title>
    <meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body>
	<div layout:fragment="content">
	    <div class="container mt-4">
	        <!-- 브레드크럼 -->
	        <nav aria-label="breadcrumb" class="mb-3">
	            <ol class="breadcrumb">
	                <li class="breadcrumb-item"><a th:href="@{/}">홈</a></li>
	                <!-- <li class="breadcrumb-item"><a th:href="@{'/board/free/list'}" th:text="${categoryName}">자유게시판</a></li> -->
	                <li class="breadcrumb-item"><a th:href="@{'/board/' + ${categoryPath} + '/list'}" th:text="${categoryName}">자유게시판</a></li>
	                <li class="breadcrumb-item active" aria-current="page">게시글 보기</li>
	            </ol>
	        </nav>
	
	        <!-- 게시글 상세 내용 -->
	        <div class="card mb-4">
	            <!-- 게시글 헤더 -->
	            <div class="card-header">
	                <div class="d-flex justify-content-between align-items-start">
	                    <div class="flex-grow-1">
	                        <h2 class="mb-2" th:text="${post.title}">게시글 제목</h2>
	                        <div class="d-flex flex-wrap align-items-center text-muted small">
	                            <span class="me-3">
	                                <i class="fas fa-user me-1"></i>
	                                <span th:text="${post.authorNickname}">작성자</span>
	                                <i th:if="${post.authorVerified}" class="fas fa-check-circle text-success ms-1" title="인증회원"></i>
	                            </span>
	                            <span class="me-3">
	                                <i class="fas fa-calendar me-1"></i>
	                                <span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">2024-01-01 12:00</span>
	                            </span>
	                            <span class="me-3">
	                                <i class="fas fa-eye me-1"></i>조회 <span th:text="${post.viewCount}">0</span>
	                            </span>
	                            <span>
	                                <i class="fas fa-comment me-1 text-primary"></i>댓글 <span th:text="${post.commentCount}">0</span>
	                            </span>
	                        </div>
	                    </div>
	                    <div class="d-flex gap-1">
	                        <span th:if="${post.isNotice}" class="badge bg-danger">공지</span>
	                        <span th:if="${post.isTop}" class="badge bg-primary">TOP</span>
	                        <span th:if="${post.hasAttachments}" class="badge bg-secondary"><i class="fas fa-paperclip"></i> 첨부</span>
	                    </div>
	                </div>
	            </div>
	
	            <!-- 게시글 내용 -->
	            <div class="card-body">
	                <div class="post-content" th:utext="${post.content}" style="min-height: 200px; line-height: 1.8;">
	                    게시글 내용이 여기에 표시됩니다.
	                </div>
	
	                <!-- 첨부파일 영역 (추후 구현) -->
	                <div th:if="${post.hasAttachments}" class="mt-4 pt-3 border-top">
	                    <h6 class="mb-3"><i class="fas fa-paperclip me-2"></i>첨부파일</h6>
	                    <div class="alert alert-info">
	                        <i class="fas fa-info-circle me-2"></i>
	                        첨부파일 기능은 곧 추가될 예정입니다.
	                    </div>
	                </div>
	            </div>
	
	            <!-- 게시글 액션 버튼들 -->
	            <div class="card-footer bg-light">
	                <div class="d-flex justify-content-between align-items-center">
	                    <div>
	                        <!-- 좋아요 버튼 -->
	                        <button class="btn btn-outline-danger btn-sm me-2" id="likeBtn" onclick="toggleLike()" th:data-post-id="${post.id}">
	                            <i class="fas fa-heart me-1"></i>
	                            좋아요 (<span id="likeCount" th:text="${post.likeCount}">0</span>)
	                        </button>
	                        
	                        <!-- 공유 버튼 -->
	                        <button class="btn btn-outline-secondary btn-sm" onclick="sharePost()">
	                            <i class="fas fa-share me-1"></i>공유
	                        </button>
	                        
	                        <!-- --- 신고 버튼 추가 --- -->
                            <button class="btn btn-outline-warning btn-sm ms-2" sec:authorize="isAuthenticated()"th:onclick="openReportModal('POST', [[${post.id}]])">
                                <i class="fas fa-flag me-1"></i>신고
                            </button>
                            <!-- ----------------------- -->
                            
	                    </div>
	
	                    <div sec:authorize="isAuthenticated()">
	                        <!-- 작성자만 보이는 버튼들 -->
	                        <div th:if="${#authentication.principal.memberId == post.memberId or #authorization.expression('hasRole(''ADMIN'')')}">
	                            <!-- <a th:href="@{'/board/free/edit/' + ${post.id}}" class="btn btn-outline-primary btn-sm me-2"> -->
	                            <a th:href="@{'/board/' + ${categoryPath} + '/edit/' + ${post.id}}" class="btn btn-outline-primary btn-sm me-2">
	                                <i class="fas fa-edit me-1"></i>수정
	                            </a>
	                            <button class="btn btn-outline-danger btn-sm" onclick="deletePost()" th:data-post-id="${post.id}">
	                                <i class="fas fa-trash me-1"></i>삭제
	                            </button>
	                        </div>
	                    </div>
	                </div>
	            </div>
	        </div>
	
	        <!-- 댓글 섹션 -->
	        <div class="card mb-4">
	            <div class="card-header d-flex justify-content-between align-items-center">
	                <h5 class="mb-0">
	                    <i class="fas fa-comments me-2"></i>
	                    댓글 <span class="badge bg-primary" th:text="${post.commentCount}">0</span>
	                </h5>
	                <button class="btn btn-primary btn-sm" onclick="toggleCommentForm()" sec:authorize="isAuthenticated()">
	                    <i class="fas fa-plus me-1"></i>댓글 작성
	                </button>
	            </div>
	            <div class="card-body">
	                <!-- 댓글 작성 폼 (로그인 시에만) -->
	                <div id="commentForm" class="mb-4" style="display: none;" sec:authorize="isAuthenticated()">
	                    <form onsubmit="submitComment(event)">
	                        <div class="mb-3">
	                            <textarea class="form-control" rows="3" placeholder="댓글을 입력하세요..." 
	                                      id="commentContent" required></textarea>
	                        </div>
	                        <div class="d-flex justify-content-end gap-2">
	                            <button type="button" class="btn btn-secondary btn-sm" onclick="toggleCommentForm()">
	                                취소
	                            </button>
	                            <button type="submit" class="btn btn-primary btn-sm">
	                                <i class="fas fa-paper-plane me-1"></i>댓글 등록
	                            </button>
	                        </div>
	                    </form>
	                </div>
	
	                <!-- 댓글 목록 -->
	                <div id="commentList">
	                    <!-- 댓글이 없을 때 -->
	                    <div th:if="${post.commentCount == 0}" class="text-center py-4 text-muted">
	                        <i class="fas fa-comment-slash fa-3x mb-3 d-block opacity-50"></i>
	                        <p>첫 번째 댓글을 작성해보세요!</p>
	                    </div>
	
	                    <!-- 댓글 기능 개발 예정 메시지 -->
	                    <div th:if="${post.commentCount > 0}" class="alert alert-info">
	                        <i class="fas fa-tools me-2"></i>
	                        댓글 기능은 현재 개발 중입니다. 곧 만나보실 수 있습니다!
	                    </div>
	                </div>
	            </div>
	        </div>
	
	        <!-- 네비게이션 버튼들 -->
	        <div class="d-flex justify-content-between align-items-center mb-5">
	            <div>
	            	<a th:href="@{'/board/' + ${categoryPath} + '/list'}" class="btn btn-outline-secondary">
	                <!-- <a th:href="@{'/board/free/list'}" class="btn btn-outline-secondary"> -->
	                    <i class="fas fa-list me-1"></i>목록으로
	                </a>
	            </div>
	            
	            <div sec:authorize="isAuthenticated()">
	            	<a th:href="@{'/board/' + ${categoryPath} + '/write'}" class="btn btn-primary">
	                    <i class="fas fa-pen me-1"></i>새 글 작성
	                </a>
	            </div>
	        </div>
	
	        <!-- 이전/다음 글 (추후 구현) -->
	        <div class="row mb-4">
	            <div class="col-12">
	                <div class="card">
	                    <div class="list-group list-group-flush">
	                        <div class="list-group-item d-flex justify-content-between align-items-center">
	                            <div>
	                                <i class="fas fa-chevron-up me-2 text-muted"></i>
	                                <strong>다음 글:</strong>
	                                <span class="text-muted ms-2">다음 게시글이 없습니다.</span>
	                            </div>
	                        </div>
	                        <div class="list-group-item d-flex justify-content-between align-items-center">
	                            <div>
	                                <i class="fas fa-chevron-down me-2 text-muted"></i>
	                                <strong>이전 글:</strong>
	                                <span class="text-muted ms-2">이전 게시글이 없습니다.</span>
	                            </div>
	                        </div>
	                    </div>
	                </div>
	            </div>
	        </div>
	    </div>
		<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="reportForm" onsubmit="submitReport(event)">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="reportModalLabel"><i class="fas fa-flag text-warning me-2"></i>신고하기</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>신고 사유를 선택해주세요. 허위 신고 시 이용이 제한될 수 있습니다.</p>
                        
                        <!-- 신고 대상 정보 -->
                        <input type="hidden" id="reportTargetType" name="targetType">
                        <input type="hidden" id="reportTargetId" name="targetId">

                        <!-- 신고 사유 -->
                        <div class="list-group list-group-flush mb-3">
                            <th:block th:each="reason : ${reportReasons}">
                                <label class="list-group-item">
                                    <input class="form-check-input me-2" type="radio" name="reportReasonCode" th:id="'reason-' + ${reason.code}" th:value="${reason.code}" required>
                                    <span th:text="${reason.name}">욕설/비방</span>
                                    <small th:if="${reason.description != null}" class="d-block text-muted" th:text="${reason.description}">욕설, 비방, 차별, 혐오 발언</small>
                                </label>
                            </th:block>
                        </div>

                        <!-- 상세 내용 (기타 선택 시 활성화) -->
                        <div class="mb-3">
                            <label for="reportDetail" class="form-label">상세 내용 (선택)</label>
                            <textarea class="form-control" id="reportDetail" name="reportDetail" rows="3" placeholder="기타 사유를 선택한 경우, 상세 내용을 입력해주세요. (1000자 이내)"></textarea>
                        </div>
                        
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="submit" class="btn btn-danger" id="reportSubmitBtn">
                            <i class="fas fa-paper-plane me-1"></i>신고 접수
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
	</div>
    <!-- 커스텀 스크립트 -->
    <th:block layout:fragment="script">
    <script>
        // 댓글 폼 토글
        function toggleCommentForm() {
            const form = document.getElementById('commentForm');
            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'block';
                document.getElementById('commentContent').focus();
            } else {
                form.style.display = 'none';
                document.getElementById('commentContent').value = '';
            }
        }

        // 댓글 작성
        function submitComment(event) {
            event.preventDefault();
            const content = document.getElementById('commentContent').value.trim();
            
            if (!content) {
                alert('댓글 내용을 입력해주세요.');
                return;
            }

            // 실제 구현 시에는 AJAX로 서버에 전송
            alert('댓글 기능은 곧 구현될 예정입니다.');
            
            // 폼 초기화
            document.getElementById('commentContent').value = '';
            toggleCommentForm();
        }

        // 게시글 삭제
        function deletePost() {
            const btn = event.target.dataset.postId ? event.target : event.target.closest('button');
            const postId = btn.dataset.postId;
            const categoryPath = "[[${categoryPath}]]";

            if (confirm('정말로 이 게시글을 삭제하시겠습니까?\n삭제된 게시글은 복구할 수 없습니다.')) {
                
                // CSRF 토큰 가져오기
                const token = document.querySelector("meta[name='_csrf']")?.getAttribute("content");
                const header = document.querySelector("meta[name='_csrf_header']")?.getAttribute("content");

                if (!token || !header) {
                    showToast('보안 토큰을 찾을 수 없습니다. 페이지를 새로고침 해주세요.', 'danger');
                    return;
                }

                fetch(`/board/api/posts/${postId}`, {
                    method: 'DELETE',
                    headers: {
                        [header]: token
                    }
                })
                .then(response => {
                    if (response.status === 401) {
                        alert('로그인이 필요합니다.');
                        window.location.href = '/login';
                        return Promise.reject('로그인 필요');
                    }
                    if (response.status === 403) {
                        return response.text().then(text => Promise.reject(text || '삭제 권한이 없습니다.'));
                    }
                    if (response.status === 404) {
                        return response.text().then(text => Promise.reject(text || '게시글을 찾을 수 없습니다.'));
                    }
                    if (!response.ok) {
                        return response.text().then(text => Promise.reject(text || '삭제 중 오류가 발생했습니다.'));
                    }
                    return response.text(); 
                })
                .then(message => {
                    showToast(message, 'success');
                    setTimeout(() => {
                        window.location.href = `/board/${categoryPath}/list`;
                    }, 1500);
                })
                .catch(error => {
                    if (error !== '로그인 필요') {
                        console.error('Delete Error:', error);
                        showToast(error.toString(), 'danger');
                    }
                });
            }
        }

        // 게시글 공유
        function sharePost() {
            const url = window.location.href;
            const title = document.title;
            
            if (navigator.share) {
                navigator.share({
                    title: title,
                    url: url
                }).then(() => {
                    console.log('공유 성공');
                }).catch((error) => {
                    console.log('공유 실패:', error);
                    fallbackShare(url);
                });
            } else {
                fallbackShare(url);
            }
        }

        // 공유 대체 방법 (URL 복사)
        function fallbackShare(url) {
            navigator.clipboard.writeText(url).then(() => {
                showToast('게시글 링크가 복사되었습니다!', 'success');
            }).catch(() => {
                prompt('이 링크를 복사하세요:', url);
            });
        }
        
        function toggleLike() {
            const btn = document.getElementById('likeBtn');
            const postId = btn.dataset.postId; // 여기서 postId 변수 가져옴
            const likeCountSpan = document.getElementById('likeCount');

            // CSRF 토큰 가져오기
            const token = document.querySelector("meta[name='_csrf']")?.getAttribute("content");
            const header = document.querySelector("meta[name='_csrf_header']")?.getAttribute("content");

            if (!token || !header) {
                console.error('CSRF token not found!');
                showToast('오류가 발생했습니다. 페이지를 새로고침 해주세요.', 'danger');
                return;
            }
            
            fetch(`/board/api/posts/${postId}/like`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token
                }
            })
            .then(response => {
                if (response.status === 401) {
                    alert('로그인이 필요합니다.');
                    window.location.href = '/login';
                    return Promise.reject('로그인 필요');
                }
                if (!response.ok) {
                    console.error('API Error:', response.status, response.statusText);
                    return response.json().then(err => Promise.reject(err.message || '서버 오류 발생'));
                }
                return response.json();
            })
            .then(data => {
                likeCountSpan.textContent = data.newLikeCount;

                if (data.userLiked) {
                    btn.classList.remove('btn-outline-danger');
                    btn.classList.add('btn-danger');
                    showToast('좋아요를 눌렀습니다!', 'success');
                } else {
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-danger');
                    showToast('좋아요를 취소했습니다.', 'info');
                }
            })
            .catch(error => {
            	console.log(error);
                if (error !== '로그인 필요') {
                     console.error('Fetch Error:', error);
                     showToast(error.toString() || '오류가 발생했습니다. 다시 시도해주세요.', 'danger');
                }
            });
        }

        // 토스트 메시지 표시
        function showToast(message, type = 'info') {
            // Bootstrap Toast 또는 간단한 알림 구현
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'info' ? 'alert-info' : 
                              type === 'warning' ? 'alert-warning' : 'alert-danger';
            
            const toast = document.createElement('div');
            toast.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <span>${message}</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(toast);
            
            // 자동으로 제거
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }
        
        let reportModalInstance = null;
        const reportModalEl = document.getElementById('reportModal');
        if (reportModalEl) {
            reportModalInstance = new bootstrap.Modal(reportModalEl);
        }
        
        function openReportModal(targetType, targetId) {
        	console.log("test1");
        	if (!reportModalInstance) {
                console.error('Report modal instance not found!');
                return;
            }
			console.log("test2");
            // 폼 초기화
            const form = document.getElementById('reportForm');
            form.reset();
            const detailText = document.getElementById('reportDetail');
            const submitBtn = document.getElementById('reportSubmitBtn');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>신고 접수';

            // 신고 대상 정보 모달에 심기
            document.getElementById('reportTargetType').value = targetType;
            document.getElementById('reportTargetId').value = targetId;

            // '기타' 사유(RER999)가 아닌 경우 상세 내용 입력란 비활성화
            const updateDetailState = () => {
                const selectedReason = form.querySelector('input[name="reportReasonCode"]:checked');
                if (selectedReason && selectedReason.value === 'RER999') {
                    detailText.disabled = false;
                    detailText.placeholder = "기타 사유를 선택한 경우, 상세 내용을 입력해주세요. (1000자 이내)";
                    detailText.required = true;
                } else {
                    detailText.disabled = true;
                    detailText.placeholder = "기타 사유 선택 시에만 입력 가능합니다.";
                    detailText.required = false;
                    detailText.value = "";
                }
            };
            
            // 라디오 버튼에 이벤트 리스너 추가
            form.querySelectorAll('input[name="reportReasonCode"]').forEach(radio => {
                radio.addEventListener('change', updateDetailState);
            });
            // 모달 열릴 때 초기 상태 설정
            updateDetailState();
            // 모달 열기
            reportModalInstance.show();
        }

        /**
         * 신고 폼 제출 (AJAX)
         */
        async function submitReport(event) {
            event.preventDefault(); // 폼 기본 제출 방지
            
            const form = event.target;
            const submitBtn = document.getElementById('reportSubmitBtn');
            submitBtn.disabled = true; // 중복 제출 방지
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 접수 중...';

            // CSRF 토큰
            const token = document.querySelector("meta[name='_csrf']")?.getAttribute("content");
            const header = document.querySelector("meta[name='_csrf_header']")?.getAttribute("content");

            if (!token || !header) {
                showToast('보안 토큰을 찾을 수 없습니다. 페이지를 새로고침 해주세요.', 'danger');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>신고 접수';
                return;
            }

            // 폼 데이터 JSON으로 직렬화
            const formData = new FormData(form);
            const reportData = {
                targetType: formData.get('targetType'),
                targetId: Number(formData.get('targetId')), // 숫자로 변환
                reportReasonCode: formData.get('reportReasonCode'),
                reportDetail: formData.get('reportDetail')
            };
            
            // 기타 사유 선택 시 상세 내용 필수 체크
            if(reportData.reportReasonCode === 'RER999' && (!reportData.reportDetail || reportData.reportDetail.trim() === '')) {
                 showToast('기타 사유를 선택한 경우, 상세 내용을 반드시 입력해야 합니다.', 'warning');
                 submitBtn.disabled = false;
                 submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>신고 접수';
                 return;
            }

            try {
                const response = await fetch('/api/reports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [header]: token
                    },
                    body: JSON.stringify(reportData)
                });

                if (response.status === 401) {
                    alert('로그인이 필요합니다.');
                    window.location.href = '/login';
                    return;
                }

                const responseText = await response.text(); // 응답을 텍스트로 우선 받음

                if (response.ok) {
                    showToast(responseText || '신고가 정상적으로 접수되었습니다.', 'success');
                    reportModalInstance.hide();
                } else {
                    // 400(Validation) 또는 409(Conflict) 에러 처리
                    showToast(responseText || '신고 접수 중 오류가 발생했습니다.', 'danger');
                }

            } catch (error) {
                console.error('Fetch Error:', error);
                showToast('네트워크 오류가 발생했습니다. 다시 시도해주세요.', 'danger');
            } finally {
                // 버튼 활성화
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>신고 접수';
            }
        }

        // 페이지 로드 시 실행
        const postContent = document.querySelector('.post-content');
        if (postContent) {
            const links = postContent.querySelectorAll('a');
            links.forEach(link => {
                if (link.hostname !== window.location.hostname) {
                    link.setAttribute('target', '_blank');
                    link.setAttribute('rel', 'noopener noreferrer');
                }
            });
        }
    </script>
    </th:block>
</body>
</html>